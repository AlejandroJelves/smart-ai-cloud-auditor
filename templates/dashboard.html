<!DOCTYPE html>
<html>
<head>
  <title>CloudLens AI Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f8f9fa; font-family: monospace; }
    .sidebar { width:220px; min-height:100vh; background:#212529; color:white; position:fixed; top:0; left:0; padding:20px; font-family: monospace; }
    .sidebar h4 { text-align:center; margin-bottom:30px; }
    .sidebar a { display:block; padding:10px; margin-bottom:15px; color:white; text-decoration:none; border-radius:5px; }
    .sidebar a:hover { background:#343a40; }
    .content { margin-left:240px; padding:20px; font-family: monospace; }

    /* KPI Cards */
    .card h6 { font-size: 0.85rem; font-family: monospace; }
    .card h2 { font-size: 1.5rem; font-family: monospace; }

    /* Chat bubble */
    #chatBubble { position:fixed; bottom:20px; right:20px; background:#0d6efd; color:white; border-radius:50%; width:60px; height:60px;
      display:flex; align-items:center; justify-content:center; font-size:24px; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.2); z-index:1000; }
    #chatWindow { position:fixed; bottom:90px; right:20px; width:320px; height:420px; background:white; border:1px solid #ccc; border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.3); display:none; flex-direction:column; z-index:1000; font-family: monospace; }
    #chatHeader { background:#0d6efd; color:white; padding:10px; border-radius:10px 10px 0 0; font-family: monospace; }
    #chatBox { flex:1; overflow-y:auto; padding:10px; font-size:14px; background:#f8f9fa; font-family: monospace; }
    .user-msg { text-align:right; background:#e9f5ff; padding:6px 10px; border-radius:12px; display:inline-block; margin:4px 0; font-family: monospace; }
    .bot-msg { text-align:left; background:#e6f4ea; padding:6px 10px; border-radius:12px; display:inline-block; margin:4px 0; font-family: monospace; }

    /* Charts smaller */
    canvas { max-height: 250px !important; }
  </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <h4>‚òÅÔ∏è CloudLens</h4>
  <a href="#" onclick="showView('overview')">Overview</a>
  <a href="#" onclick="showView('gcp')">Google Cloud</a>
  <a href="#" onclick="showView('aws')">AWS</a>
  <a href="#" onclick="showView('azure')">Azure</a>
</div>

<!-- Main Content -->
<div class="content">

  <!-- Overview -->
  <div id="overview" class="view">
    <h3>Overview</h3>
    <div class="row text-center mt-3">
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Total Spend</h6><h2 id="totalSpend">$0</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Google Cloud</h6><h2 id="gcpSpend">$0</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>AWS</h6><h2 id="awsSpend">$0</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Azure</h6><h2 id="azureSpend">$0</h2></div></div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card p-3 shadow-sm">
          <h6>Spend by Provider</h6>
          <canvas id="providerPie"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3 shadow-sm">
          <h6>Daily Cost Trend</h6>
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- GCP -->
  <div id="gcp" class="view" style="display:none;">
    <h3>Google Cloud Details</h3>
    <div class="row text-center mt-3">
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Total Spend</h6><h2 id="gcpTotal">$0</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Avg Daily Spend</h6><h2 id="gcpAvg">$0</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Budget Status</h6><h2 id="gcpBudget">-</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Idle Resources</h6><h2 id="gcpIdle">0</h2></div></div>
    </div>
    <div class="row mt-4"><div class="col-md-12"><canvas id="gcpLine"></canvas></div></div>
  </div>

  <!-- AWS -->
  <div id="aws" class="view" style="display:none;">
    <h3>AWS Details</h3>
    <div class="row text-center mt-3">
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Total Spend</h6><h2 id="awsTotal">$0</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Avg Daily Spend</h6><h2 id="awsAvg">$0</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Budget Status</h6><h2 id="awsBudget">-</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Idle Resources</h6><h2 id="awsIdle">0</h2></div></div>
    </div>
    <div class="row mt-4"><div class="col-md-12"><canvas id="awsLine"></canvas></div></div>
  </div>

  <!-- Azure -->
  <div id="azure" class="view" style="display:none;">
    <h3>Azure Details</h3>
    <div class="row text-center mt-3">
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Total Spend</h6><h2 id="azureTotal">$0</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Avg Daily Spend</h6><h2 id="azureAvg">$0</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Budget Status</h6><h2 id="azureBudget">-</h2></div></div>
      <div class="col-md-3"><div class="card p-3 shadow-sm"><h6>Idle Resources</h6><h2 id="azureIdle">0</h2></div></div>
    </div>
    <div class="row mt-4"><div class="col-md-12"><canvas id="azureLine"></canvas></div></div>
  </div>
</div>

<!-- Floating Chat -->
<div id="chatBubble">üí¨</div>
<div id="chatWindow">
  <div id="chatHeader">CloudLens Assistant</div>
  <div id="chatBox"></div>
  <div style="padding:10px; border-top:1px solid #ccc;">
    <input type="text" id="userInput" class="form-control form-control-sm" placeholder="Ask a question..." />
    <button class="btn btn-primary btn-sm mt-2 w-100" onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
// Toggle views
function showView(viewId) {
  document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
  document.getElementById(viewId).style.display = 'block';
}
showView('overview'); // default

// Load dummy costs
fetch("/api/costs")
  .then(res => res.json())
  .then(data => {
    const gcp = data.filter(d => d.provider==="gcp");
    const aws = data.filter(d => d.provider==="aws");
    const azure = data.filter(d => d.provider==="azure");

    const sum = arr => arr.reduce((a,b)=>a+b.cost,0);
    const gcpTotal=sum(gcp), awsTotal=sum(aws), azureTotal=sum(azure);
    const total=gcpTotal+awsTotal+azureTotal;

    // Overview tiles
    document.getElementById("totalSpend").innerText=`$${total.toFixed(2)}`;
    document.getElementById("gcpSpend").innerText=`$${gcpTotal.toFixed(2)}`;
    document.getElementById("awsSpend").innerText=`$${awsTotal.toFixed(2)}`;
    document.getElementById("azureSpend").innerText=`$${azureTotal.toFixed(2)}`;

    // Pie chart (overview)
    new Chart(document.getElementById("providerPie"), {
      type:"doughnut",
      data:{labels:["Google Cloud","AWS","Azure"],datasets:[{data:[gcpTotal,awsTotal,azureTotal],backgroundColor:["#4285F4","#FF9900","#0078D4"]}]}
    });

    // Trend (overview)
    new Chart(document.getElementById("trendChart"), {
      type:"line",
      data:{
        labels:["Mon","Tue","Wed","Thu","Fri"],
        datasets:[
          {label:"GCP",data:[50,70,60,90,120],borderColor:"#4285F4",fill:false},
          {label:"AWS",data:[40,60,55,80,100],borderColor:"#FF9900",fill:false},
          {label:"Azure",data:[30,50,45,70,90],borderColor:"#0078D4",fill:false}
        ]
      }
    });

    // Build insights per provider
    function buildProviderInsights(total, totalId, avgId, budgetId, idleId, lineId, color, budget=500) {
      document.getElementById(totalId).innerText = `$${total.toFixed(2)}`;
      const avg = total / 30;
      document.getElementById(avgId).innerText = `$${avg.toFixed(2)}`;
      document.getElementById(budgetId).innerText = total > budget ? "‚ö†Ô∏è Over Budget" : "‚úÖ Under Budget";
      document.getElementById(idleId).innerText = avg < 20 ? 3 : 1; // mock logic
      new Chart(document.getElementById(lineId), {
        type:"line",
        data:{labels:["Mon","Tue","Wed","Thu","Fri"],datasets:[{label:"Daily Spend",data:[20,30,40,25,50],borderColor:color,fill:false}]}
      });
    }

    buildProviderInsights(gcpTotal, "gcpTotal","gcpAvg","gcpBudget","gcpIdle","gcpLine","#4285F4");
    buildProviderInsights(awsTotal, "awsTotal","awsAvg","awsBudget","awsIdle","awsLine","#FF9900");
    buildProviderInsights(azureTotal, "azureTotal","azureAvg","azureBudget","azureIdle","azureLine","#0078D4");
  });

// Chat toggle
document.getElementById("chatBubble").addEventListener("click",()=> {
  const cw=document.getElementById("chatWindow");
  cw.style.display=(cw.style.display==="none"||cw.style.display==="")?"flex":"none";
});

// Chat logic
function sendMessage(){
  const input=document.getElementById("userInput");
  const msg=input.value.trim(); if(!msg)return;
  const chatBox=document.getElementById("chatBox");
  chatBox.innerHTML+=`<div class="user-msg">üë§ ${msg}</div>`;
  fetch("/api/agent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:msg})})
  .then(res=>res.json()).then(data=>{
    chatBox.innerHTML+=`<div class="bot-msg">ü§ñ ${data.answer}</div>`;
    chatBox.scrollTop=chatBox.scrollHeight;
  });
  input.value="";
}
</script>
</body>
</html>
