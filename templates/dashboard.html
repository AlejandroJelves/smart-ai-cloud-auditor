<!DOCTYPE html>
<html>
<head>
  <title>CloudLens AI Dashboard</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #d8d8d8; font-family: monospace; }
    .sidebar { width:220px; min-height:100vh; background:#212529; color:white; position:fixed; top:0; left:0; padding:20px; }
    .sidebar h4 { text-align:center; margin-bottom:30px; }
    .sidebar a { display:block; padding:10px; margin-bottom:15px; color:white; text-decoration:none; border-radius:5px; }
    .sidebar a:hover { background:#343a40; }
    .content { margin-left:240px; padding:20px; }
    .card { padding: 16px !important; min-height: 145px; display:flex; flex-direction:column; justify-content:center; align-items:center; overflow: hidden; }
    .metric-title { font-size: 14px; color: #f2f2f2; }
    .metric-value { font-size: 36px; font-weight:700; line-height:1.1; color:#fff; }
    .metric-sub { font-size: 14px; color:#ddd; }
    .metric-fixed { font-variant-numeric: tabular-nums; }
    canvas { max-height: 270px !important; }
  </style>
</head>
<body>

<div class="sidebar">
  <h4>‚òÅÔ∏è CloudLens</h4>
  <a href="#" onclick="showView('overview')">Overview</a>
  <a href="#" onclick="showView('gcp')">Google Cloud</a>
</div>

<div class="content">
  <!-- Overview -->
  <div id="overview" class="view">
    <h3>Overview</h3>
    <div class="row text-center mt-3">
      <div class="col-md-3"><div class="card shadow-sm"><div class="metric-title">Total Spend</div><div class="metric-value metric-fixed" id="totalSpend">$0</div></div></div>
      <div class="col-md-3"><div class="card shadow-sm"><div class="metric-title">Google Cloud</div><div class="metric-value metric-fixed" id="gcpSpend">$0</div></div></div>
      <div class="col-md-3"><div class="card shadow-sm"><div class="metric-title">AWS</div><div class="metric-value metric-fixed" id="awsSpend">$0</div></div></div>
      <div class="col-md-3"><div class="card shadow-sm"><div class="metric-title">Azure</div><div class="metric-value metric-fixed" id="azureSpend">$0</div></div></div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="metric-title">Spend by Provider</div>
          <canvas id="providerPie"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="d-flex justify-content-between w-100">
            <div class="metric-title">Daily Cost Trend</div>
            <select id="overviewRange" class="form-select form-select-sm" style="width:150px;" onchange="updateOverviewChart()">
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="180">Last 6 months</option>
              <option value="365">Last Year</option>
            </select>
          </div>
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mt-4">
      <div class="metric-title">ü§ñ Quick AI Summary</div>
      <p id="overviewSummary">Loading insights...</p>
    </div>
  </div>

  <!-- GCP -->
  <div id="gcp" class="view" style="display:none;">
    <h3>Google Cloud: Live Metrics</h3>
    <div class="row text-center mt-3">
      <div class="col-md-2">
        <div class="card shadow-sm" style="background:#555;color:#fff;">
          <div class="metric-title">CPU Usage</div>
          <div class="metric-value metric-fixed" id="gcpCPU">-</div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card shadow-sm" style="background:#555;color:#fff;">
          <div class="metric-title">Traffic</div>
          <div class="metric-value metric-fixed" id="gcpTraffic">0.00 / 0.00</div>
          <div class="metric-sub">Mbps (in/out)</div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card shadow-sm" style="background:#555;color:#fff;">
          <div class="metric-title">Disk (R/W)</div>
          <div class="metric-value metric-fixed" id="gcpDisk">0.00 / 0.00</div>
          <div class="metric-sub">MB/s</div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card shadow-sm" style="background:#555;color:#fff;">
          <div class="metric-title">Error Logs (5m)</div>
          <div class="metric-value metric-fixed" id="gcpLogs">0</div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="metric-title">Network Traffic (Mbps) ‚Äî last 30 min</div>
          <canvas id="trafficLine"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="metric-title">CPU Utilization (%) ‚Äî last 30 min</div>
          <canvas id="cpuLine"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const PROVIDERS = {
  gcp:   { name: "Google Cloud", color: "#EB7C75" },
  aws:   { name: "AWS",          color: "#8CABFF" },
  azure: { name: "Azure",        color: "#FF8CB4" },
};

function normalizeDatasets(datasets) {
  const fallback = Object.values(PROVIDERS);
  return (datasets || []).map((ds, i) => {
    const key = (ds.id || ds.provider || ds.label || "").toString().toLowerCase().trim();
    const meta = PROVIDERS[key] || fallback[i % fallback.length];
    return {
      ...ds,
      label: ds.label || meta.name,
      borderColor: meta.color,
      backgroundColor: meta.color,
      pointBackgroundColor: meta.color,
      pointBorderColor: meta.color,
      tension: ds.tension ?? 0.25,
      fill: false
    };
  });
}

// view toggler
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
  document.getElementById(id).style.display = 'block';
  if (id === "gcp") {
    refreshTiles();
    drawTraffic();
    drawCPU();
  }
}
showView('overview');

// overview tiles+pie
fetch("/api/costs")
  .then(r => r.json())
  .then(data => {
    const gcp = data.filter(d => d.provider==="gcp");
    const aws = data.filter(d => d.provider==="aws");
    const azure = data.filter(d => d.provider==="azure");
    const sum = arr => arr.reduce((a,b)=>a+b.cost,0);
    const gcpTotal=sum(gcp), awsTotal=sum(aws), azureTotal=sum(azure);
    const total=gcpTotal+awsTotal+azureTotal;
    document.getElementById("totalSpend").innerText=`$${total.toFixed(2)}`;
    document.getElementById("gcpSpend").innerText=`$${gcpTotal.toFixed(2)}`;
    document.getElementById("awsSpend").innerText=`$${awsTotal.toFixed(2)}`;
    document.getElementById("azureSpend").innerText=`$${azureTotal.toFixed(2)}`;

    new Chart(document.getElementById("providerPie"), {
      type:"doughnut",
      data:{ labels:["GCP","AWS","Azure"], datasets:[{ data:[gcpTotal,awsTotal,azureTotal], backgroundColor:["#EB7C75","#8CABFF","#FF8CB4"]}] }
    });
    updateOverviewChart();
    // short summary
    fetch("/api/summary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data})})
      .then(r=>r.json()).then(o => document.getElementById("overviewSummary").innerText = o.summary || "No summary.");
  });

// overview trend line
let trendChart;
function updateOverviewChart(){
  const range = document.getElementById("overviewRange").value;
  fetch(`/api/costs?range=${range}`)
    .then(r => r.json())
    .then(data => {
      trendChart && trendChart.destroy();
      const datasets = normalizeDatasets(data.datasets);
      trendChart = new Chart(document.getElementById("trendChart"), {
        type:"line",
        data:{ labels:data.labels, datasets },
        options:{ responsive:true, scales:{y:{beginAtZero:true}}}
      });
    });
}

// Live GCP tiles
function refreshTiles(){
  fetch("/api/tiles")
    .then(r=>r.json())
    .then(t=>{
      document.getElementById("gcpCPU").innerText = `${t.cpu_percent.toFixed(1)}%`;
      document.getElementById("gcpTraffic").innerText = `${(t.traffic.mbps_in || 0).toFixed(2)} / ${(t.traffic.mbps_out||0).toFixed(2)}`;
      document.getElementById("gcpDisk").innerText = `${(t.disk.read_mbs || 0).toFixed(2)} / ${(t.disk.write_mbs||0).toFixed(2)}`;
      document.getElementById("gcpLogs").innerText = `${t.errors_5m || 0}`;
    });
}
setInterval(()=>{ if(document.getElementById("gcp").style.display!=="none") refreshTiles(); }, 30000);

// traffic chart
let trafficChart;
function drawTraffic(){
  fetch("/api/traffic").then(r=>r.json()).then(d=>{
    trafficChart && trafficChart.destroy();
    const ds = normalizeDatasets(d.datasets);
    trafficChart = new Chart(document.getElementById("trafficLine"), {
      type:"line",
      data: { labels:d.labels, datasets: ds },
      options:{responsive:true, scales:{y:{beginAtZero:true}}}
    });
  });
}

// cpu chart
let cpuChart;
function drawCPU(){
  fetch("/api/cpu").then(r=>r.json()).then(d=>{
    cpuChart && cpuChart.destroy();
    const ds = normalizeDatasets(d.datasets);
    cpuChart = new Chart(document.getElementById("cpuLine"), {
      type:"line",
      data: { labels:d.labels, datasets: ds },
      options:{responsive:true, scales:{y:{beginAtZero:true, max:100}}}
    });
  });
}
</script>
</body>
</html>
